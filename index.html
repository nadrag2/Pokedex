<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    
    <title>Pokedex</title>
</head>

<body>

    <div class="container">
        <div class="search">
            <form id="form">
                <input type="text" id="namesearch" name="namesearch" placeholder="Digite o nome de um Pokémon"
                    autocomplete="off" onkeyup="showResults(this.value)" />
                <div id="result-list"></div>
                <!--   <button type="submit" for="namesearch">Buscar</button> -->
            </form>
        </div>

        <div class="info-container-geral">
            <div class="info-container">
                <div class="info">
                    <label for="name">NOME:</label>
                    <label id="name"></label>
                    <img src="" id="picSprite" height="100" alt="Pokemon Image"><br>
                    <label for="id">ID:</label>
                    <label id="id"></label><br>
                    <label for="height">TAMANHO:</label>
                    <label id="height"></label><br>
                    <label for="weight">PESO:</label>
                    <label id="weight"></label><br>
                    <label for="element">ELEMENTO(S):</label>
                    <label id="element"></label><br>
                </div>

                <img src="" id="picOfficial" height="250" alt="Pokemon Image">
            </div>

            <div id="evo-container">
                <div id="evo-label">
                    <p>Familia de evolução</p><br>
                </div>

                <div class="evoClass">
                    <ul id="evolutions-list"></ul>
                </div>
            </div>
        </div>
    </div>



    <!-- JS SCRIPT -->
    <script>

        /* DECLARAÇÃO DE VARIÁVEIS */
        let pkName = localStorage.getItem("pkName");
        const form = document.getElementById("form");
        let liName = document.getElementById("pokemon-name-list-filter");
        let evoNameArray = [];
        let evoArray = [];

        /* BUSCA */
        form.addEventListener("submit", function () {
            const name = document.getElementById("namesearch").value;
            pkName = name;
            localStorage.setItem("pkName", pkName);
        })


        function listGetPokemon(value) {
            const name = value;
            pkName = name;
            localStorage.setItem("pkName", pkName);
            window.location.reload();
        }

        /* FUNÇÕES */
        function assignDataToElement(id, name, height, weight, element, imgsprite, imgoff) {
            document.getElementById("id").innerHTML = `${id}`;
            document.getElementById("name").innerHTML = `${name.slice(0, 1).toLocaleUpperCase()}${name.slice(1)}`;
            document.getElementById("height").innerHTML = `${addADot(height)} m`;
            document.getElementById("weight").innerHTML = `${addADot(weight)} kg`;
            document.getElementById("element").innerHTML = `${pokemonElement(element)}`;
            document.getElementById("picSprite").src = imgsprite.front_default;
            document.getElementById("picOfficial").src = imgoff.other["official-artwork"].front_default;

        }

        function addADot(number) {
            if (number < 9) {
                number = `0${number}`;
            }
            let strNumber = number.toString();
            strNumber = `${strNumber.slice(0, -1)}.${strNumber.slice(-1)}`
            return strNumber;
        }

        function pokemonElement(element) {
            let elementArray = [];
            element.forEach((data) => {
                elementArray.push(data.type.name);
            });
            return elementArray.join(", ").toLocaleUpperCase();

        }

        /* ADICIONA TODA A CADEIA DE EVOLUÇÃO DE UM POKÉMON A UM ARRAY */
        function getEvoArray(evo, evo1) {
            evoArray.push(evo1.species.name);
            evo.forEach((data) => {
                evoArray.push(data.species.name);
                if (data.evolves_to[0]) {
                    evoArray.push(data.evolves_to[0].species.name)
                }
            });
            return evoArray;
        }

        function pokemonChain(data) {
            let evoChainUrl = data.evolution_chain.url;
            fetch(`${evoChainUrl}`)
                .then((response) => (response.json()))
                .then((data) => {
                    getEvoArray(data.chain.evolves_to, data.chain);
                    let ul = document.getElementById("evolutions-list");

                    for (var i = 0; i < evoArray.length; i++) {
                        let li = document.createElement("li");
                        li.appendChild(document.createTextNode(evoArray[i]));
                        li.setAttribute("id", `evo${i}`);
                        li.setAttribute("class", "evoList");
                        li.addEventListener("click", function () {
                            pkName = this.innerHTML;
                            localStorage.setItem("pkName", pkName);
                            window.location.reload();
                        }
                        );
                        ul.appendChild(li);
                    }
                })
        }

        /* FETCH */

        /* POKÉMON */
        fetch(`https://pokeapi.co/api/v2/pokemon/${pkName.toLowerCase()}/`)
            .then((response) => {
                if (response.ok) return response.json()
                else throw new Error(alert(`Pokémon não encontrado. ERRO ${response.status}`))
            })
            .then((data) => (
                assignDataToElement(data.id, data.name, data.height, data.weight, data.types, data.sprites, data.sprites), console.log(data)
            ))
            .catch((err) => (console.log(err)))

        /* EVOLUÇÃO */
        fetch(`https://pokeapi.co/api/v2/pokemon-species/${pkName.toLowerCase()}/`)
            .then((response) => (response.json()))
            .then((data) => (pokemonChain(data)))

        /* FETCH NOMES */
        fetch(`https://pokeapi.co/api/v2/pokemon/?offset=0&limit=1200`)
            .then((response) => (response.json()))
            .then((data) => {
                let item = data.results;
                item.forEach(data => {
                    evoNameArray.push(data.name);
                })
            });

        function autoComplete(input) {
            if (input == "") {
                return [];
            }
            var reg = RegExp(input);
            return evoNameArray.filter(function (name) {
                if (name.match(reg)) {
                    return name;
                }
            });
        }

        function showResults(value) {
            let res = document.getElementById("result-list");
            let ul = document.getElementById("nameListFilter");
            res.innerHTML = "";
        
            let list = "";
            let terms = autoComplete(value);

            for (i = 0; i < terms.length; i++) {
                list += `<li class="li-filter-item" onclick="listGetPokemon(this.innerHTML)">${terms[i]}</li>`;
            }
            res.innerHTML = `<ul id="pokemon-name-list-filter">${list}</ul>`
            let pkListFilter = document.getElementById("pokemon-name-list-filter");

            if(pkListFilter.getElementsByTagName("li").length == 0){
                pkListFilter.remove();
            }
        }
    </script>
</body>

</html>